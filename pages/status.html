<!DOCTYPE html>
<html>
<head>
    <title>Generating Your Song</title>
    <link rel="stylesheet" href="/styles/main.css">
</head>
<body>
    <div class="nav">
        <a href="/">Home</a>
        <a href="/gallery">Gallery</a>
    </div>
    
    <div class="container">
        <div class="card">
            <h1>Your Birthday Song</h1>
            
            <div id="status" class="status-message">
                Initializing song generation...
            </div>
            
            <div id="audioSection" class="audio-section" style="display: none;">
                <h2>Your Song is Ready!</h2>
                <audio controls>
                    <source id="audioSource" src="" type="audio/mpeg">
                    Your browser does not support the audio element.
                </audio>
            </div>
            
            <div id="lyricsSection" class="lyrics-section">
                <h2>Your Lyrics:</h2>
                <div id="lyrics" class="lyrics"></div>
            </div>
            
            <div class="action-buttons">
                <a href="/" class="button secondary">Create Another Song</a>
            </div>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const trackingId = urlParams.get('id');
        let attempts = 0;
        const maxAttempts = 40;
        
        async function checkStatus() {
            if (attempts >= maxAttempts) {
                document.getElementById('status').innerHTML = 
                    'Song generation is taking longer than expected. Please <a href="/">try again</a>.';
                return;
            }
            
            try {
                const response = await fetch(`/api/check-status/${trackingId}`);
                const data = await response.json();
                
                document.getElementById('status').textContent = data.message;
                
                if (data.status === 'completed' && data.audio_url) {
                    document.getElementById('status').style.display = 'none';
                    document.getElementById('audioSection').style.display = 'block';
                    document.getElementById('audioSource').src = data.audio_url;
                    document.querySelector('audio').load();
                } else if (data.status === 'failed') {
                    document.getElementById('status').innerHTML = 
                        'Failed to generate song. Please <a href="/">try again</a>.';
                } else {
                    attempts++;
                    setTimeout(checkStatus, 5000);
                }
            } catch (error) {
                console.error('Error:', error);
                attempts++;
                setTimeout(checkStatus, 5000);
            }
        }
        
        // Start checking status if we have a tracking ID
        if (trackingId) {
            checkStatus();
        } else {
            window.location.href = '/';
        }
    </script>
</body>
</html>